<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat con Voz</title>
  <link rel="stylesheet" href="hojadeestilo.css">
  <style>
    /* Feedback visual cuando el micro está activo */
    .mic-img.listening { filter: drop-shadow(0 0 6px rgba(0,150,255,.7)); transform: scale(1.04); }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="container">
      
      <header class="header">
        <img src="img/logoproyecto.png" alt="Logo Proyecto" class="logo-top-left" />
      </header>

      <section class="chat-area">
        <div class="avatar-wrap">
          <img src="img/rito.png" alt="Rito" class="avatar-fixed">
        </div>

        <div class="bubble-column">
          <div id="bubbleStack" class="bubble-stack"></div>

          <div id="loadingDots" class="typing-dots" style="display:none;">
            <span></span><span></span><span></span>
          </div>

          <div class="button-group-vertical">
            <button id="btnDetenerVoz" class="boton-detener oculto" onclick="detenerVoz()">⏹ Detener voz</button>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <p>
        &copy; 2025 Aranzadi La Ley. Todos los derechos reservados. |
        <a href="https://www.aranzadilaley.es/aviso-legal-ia.html" target="_blank" rel="noopener noreferrer">Aviso Legal</a>
      </p>
    </footer>
  </div>

  <img src="img/logo nuevo.png" alt="Logo Nuevo" class="logo-bottom-right" />

  <script>
    // ========= Reconocimiento de voz (STT) =========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    let micActivo = false;

    // ========= Síntesis de voz (TTS) =========
    let reproducirVoz = true;
    let velocidad = 1;       // 1 = normal
    let vozSeleccionada = null;
    let pitchMasculino = 0.85; // un poco más grave

    // Preferencias de voces masculinas (ajusta los nombres si en tu equipo hay otras)
    const MALE_VOICE_PREFERENCES = [
      "Microsoft Pablo - Spanish (Spain)",
      "Microsoft Raul - Spanish (Mexico)",
      "Diego", "Jorge", "Juan", "Miguel", "Pablo", "Alberto",
      "Male", "Hombre" // palabras clave por si el nombre lo indica
    ];

    // ====== Persistencia del hilo entre turnos ======
    let THREAD_ID = localStorage.getItem("openai_thread_id") || null;

    document.addEventListener('DOMContentLoaded', () => {
      // Config STT
      if (recognition) {
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "es-ES";

        recognition.onstart = () => {
          micActivo = true;
          const micBtn = document.getElementById('micBtn');
          if (micBtn) micBtn

