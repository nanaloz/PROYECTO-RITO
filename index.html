<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat con Voz</title>
  <link rel="stylesheet" href="hojadeestilo.css">
</head>
<body>
  <div class="page-wrapper">
    <div class="container">
      
      <!-- Logo proyecto ARRIBA IZQUIERDA -->
      <header class="header">
        <img src="img/logoproyecto.png" alt="Logo Proyecto" class="logo-top-left" />
      </header>

      <!-- Zona de chat: avatar fijo (Rito) + pila de bocadillos -->
      <section class="chat-area">
        <div class="avatar-wrap">
          <img src="img/rito.png" alt="Rito" class="avatar-fixed">
        </div>

        <div class="bubble-column">
          <!-- aquÃ­ se apilan los bocadillos -->
          <div id="bubbleStack" class="bubble-stack"></div>

          <!-- escribiendoâ€¦ -->
          <div id="loadingDots" class="typing-dots" style="display:none;">
            <span></span><span></span><span></span>
          </div>

          <!-- input + botones -->
          <input type="text" id="textInput" placeholder="Hazme una pregunta..." />
          <div class="button-group-vertical">
            <button onclick="startRecognition()">ğŸ™ Hablar</button>
            <button onclick="sendMessage()">ğŸ“© Enviar</button>
            <button id="btnDetenerVoz" class="boton-detener oculto" onclick="detenerVoz()">â¹ Detener voz</button>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <p>
        &copy; 2025 Aranzadi La Ley. Todos los derechos reservados. |
        <a href="https://www.aranzadilaley.es/aviso-legal-ia.html" target="_blank" rel="noopener noreferrer">Aviso Legal</a>
      </p>
    </footer>
  </div>

  <!-- Logo nuevo ABAJO DERECHA -->
  <img src="img/logo nuevo.png" alt="Logo Nuevo" class="logo-bottom-right" />

  <!-- LÃ³gica de voz + chat -->
  <script>
    const AVATAR_BOT_SRC = "img/rito.png";
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    let micActivo = false;
    let reproducirVoz = true;
    let velocidad = 1;
    let vozSeleccionada = null;

    document.addEventListener('DOMContentLoaded', () => {
      if (recognition) {
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = "es-ES";
        recognition.onresult = (event) => {
          const transcript = event.results[event.results.length - 1][0].transcript;
          const input = document.getElementById("textInput");
          input.value = input.value.trim() !== "" ? input.value + " " + transcript : transcript;
        };
        recognition.onerror = () => { micActivo = false; };
      }
      cargarVoces();
      window.speechSynthesis.onvoiceschanged = cargarVoces;

      // Mensaje de bienvenida
      addMessage("Â¡Hola! Soy Rito. Hazme una pregunta y te respondo ;)", "bot");
    });

    function toggleVoz() { reproducirVoz = true; }
    function cargarVoces() {
      const voces = window.speechSynthesis.getVoices();
      const vocesES = voces.filter(v => v.lang.startsWith("es"));
      vozSeleccionada = vocesES[0] || null;
    }

    function startRecognition() {
      if (recognition && !micActivo) {
        document.getElementById("textInput").value = "";
        recognition.start();
        micActivo = true;
      }
    }

    async function sendMessage() {
      const input = document.getElementById("textInput");
      const inputValue = input.value.trim();
      if (!inputValue) return;

      if (recognition && micActivo) {
        recognition.stop();
        micActivo = false;
      }

      addMessage(inputValue, "user");
      input.value = "";
      document.getElementById("loadingDots").style.display = "flex";
      setUIBusy(true);

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: inputValue })
        });
        const data = await response.json();
        const respuestaTexto = data?.response
          ? (typeof data.response === "object"
              ? (data.response.message || data.response.content || JSON.stringify(data.response))
              : String(data.response))
          : "No se recibiÃ³ una respuesta vÃ¡lida.";

        addMessage(respuestaTexto, "bot");
        speak(respuestaTexto);

      } catch (e) {
        console.error(e);
        addMessage("No se pudo conectar con la IA.", "bot");
      } finally {
        document.getElementById("loadingDots").style.display = "none";
        setUIBusy(false);
      }
    }

    function formatTime(date=new Date()){
      return date.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
    }

    function addMessage(text, sender) {
      const stack = document.getElementById("bubbleStack");
      const bubble = document.createElement("div");
      bubble.className = `bubble ${sender}`;

      const msg = document.createElement("div");
      msg.textContent = text;

      const t = document.createElement("time");
      t.dateTime = new Date().toISOString();
      t.textContent = formatTime();

      bubble.appendChild(msg);
      bubble.appendChild(t);
      stack.appendChild(bubble);

      stack.parentElement.scrollTo({ top: stack.parentElement.scrollHeight, behavior: "smooth" });
    }

    function speak(text) {
      if (!reproducirVoz || !('speechSynthesis' in window)) return;
      const synth = window.speechSynthesis;
      const utt = new SpeechSynthesisUtterance(text);
      utt.lang = recognition ? recognition.lang : "es-ES";
      utt.rate = velocidad;
      if (vozSeleccionada) utt.voice = vozSeleccionada;
      utt.onstart = () => document.getElementById("btnDetenerVoz").classList.remove("oculto");
      utt.onend   = () => document.getElementById("btnDetenerVoz").classList.add("oculto");
      synth.speak(utt);
    }

    function detenerVoz() {
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        document.getElementById("btnDetenerVoz").classList.add("oculto");
      }
    }

    function setUIBusy(busy){
      document.querySelectorAll(".button-group-vertical button").forEach(b=>b.disabled = busy);
      document.getElementById("textInput").disabled = busy;
    }

    // Enviar con Enter (Shift+Enter hace salto de lÃ­nea)
    document.getElementById("textInput").addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>


 
      
  


