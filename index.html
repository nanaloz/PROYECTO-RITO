
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat con Voz</title>
  <link rel="stylesheet" href="hojadeestilo.css">
  <style>
    /* Opcional: feedback visual cuando el micro está activo */
    .mic-img.listening { filter: drop-shadow(0 0 6px rgba(0,150,255,.7)); transform: scale(1.04); }
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="container">
      
      <header class="header">
        <img src="img/logoproyecto.png" alt="Logo Proyecto" class="logo-top-left" />
      </header>

      <section class="chat-area">
        <div class="avatar-wrap">
          <img src="img/rito.png" alt="Rito" class="avatar-fixed">
        </div>

        <div class="bubble-column">
          <div id="bubbleStack" class="bubble-stack"></div>

          <div id="loadingDots" class="typing-dots" style="display:none;">
            <span></span><span></span><span></span>
          </div>
          <div class="button-group-vertical">
            <button id="btnDetenerVoz" class="boton-detener oculto" onclick="detenerVoz()">⏹ Detener voz</button>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <p>
        &copy; 2025 Aranzadi La Ley. Todos los derechos reservados. |
        <a href="https://www.aranzadilaley.es/aviso-legal-ia.html" target="_blank" rel="noopener noreferrer">Aviso Legal</a>
      </p>
    </footer>
  </div>

  <img src="img/logo nuevo.png" alt="Logo Nuevo" class="logo-bottom-right" />

  <script>
    // Compatibilidad Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    let micActivo = false;
    let reproducirVoz = true;
    let velocidad = 1;
    let vozSeleccionada = null;

    // ====== NUEVO: persistencia del hilo entre turnos ======
    let THREAD_ID = localStorage.getItem("openai_thread_id") || null; // NUEVO

    // ==== Configuración inicial
    document.addEventListener('DOMContentLoaded', () => {
      if (recognition) {
        recognition.continuous = false;       // una frase por activación (más predecible)
        recognition.interimResults = false;   // resultados finales
        recognition.lang = "es-ES";

        recognition.onstart = () => {
          micActivo = true;
          const micBtn = document.getElementById('micBtn');
          if (micBtn) micBtn.classList.add('listening');
        };
        recognition.onend = () => {
          micActivo = false;
          const micBtn = document.getElementById('micBtn');
          if (micBtn) micBtn.classList.remove('listening');
        };
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const input = document.getElementById("textInput");
          input.value = transcript;
        };
        recognition.onerror = (e) => {
          console.error("Reconocimiento error:", e.error);
          micActivo = false;
          const micBtn = document.getElementById('micBtn');
          if (micBtn) micBtn.classList.remove('listening');
          if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
            alert('Permite el acceso al micrófono en tu navegador para usar el dictado.');
          }
        };
      } else {
        console.warn("Este navegador no soporta SpeechRecognition (prueba Chrome/Edge/Safari en HTTPS).");
      }

      cargarVoces();
      window.speechSynthesis.onvoiceschanged = cargarVoces;

      // Bocadillo superior: "Hazme una pregunta" + micro + flecha
      addComposeBubble();
    });

    function cargarVoces() {
      const voces = window.speechSynthesis.getVoices();
      vozSeleccionada = voces.find(v => v.lang.startsWith("es")) || null;
    }

    // ==== ACTIVAR / DETENER MICRO ====
    async function startRecognition() {
      if (!recognition) {
        alert("Tu navegador no soporta reconocimiento de voz.");
        return;
      }
      // Toggle: si ya está activo, lo paramos
      if (micActivo) {
        recognition.stop();
        return;
      }
      try {
        // Pedir permiso explícito al micro (requerido por algunos navegadores)
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          // cerramos inmediatamente (solo queremos el permiso)
          stream.getTracks().forEach(t => t.stop());
        }
        recognition.start(); // esto dispara onstart si todo va bien
      } catch (err) {
        console.error("No se pudo iniciar el micro:", err);
        alert("No se pudo acceder al micrófono. Revisa permisos del navegador.");
      }
    }

    function detenerVoz() {
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        document.getElementById("btnDetenerVoz").classList.add("oculto");
      }
    }

    function speak(text) {
      if (!reproducirVoz || !('speechSynthesis' in window)) return;
      const utt = new SpeechSynthesisUtterance(text);
      utt.lang = "es-ES";
      utt.rate = velocidad;
      if (vozSeleccionada) utt.voice = vozSeleccionada;
      utt.onstart = () => document.getElementById("btnDetenerVoz").classList.remove("oculto");
      utt.onend   = () => document.getElementById("btnDetenerVoz").classList.add("oculto");
      window.speechSynthesis.speak(utt);
    }

    // ==== UI: bocadillos
    function addComposeBubble(){
      const stack = document.getElementById("bubbleStack");
      const bubble = document.createElement("div");
      bubble.className = "bubble compose bot";
      const left = document.createElement("div");
      left.className = "text";
      const input = document.createElement("input");
      input.type = "text";
      input.id = "textInput";            // el mismo id para que el código existente funcione
      input.placeholder = "Escribe aquí tu pregunta";
      input.style.width = "100%";
      left.appendChild(input);

      const right = document.createElement("div");
      right.className = "meta-right";

      const micImg = document.createElement("img");
      micImg.id = "micBtn";
      micImg.src = "img/micro.png";
      micImg.alt = "Micrófono";
      micImg.className = "mic-img";
      micImg.title = "Hablar";
      micImg.addEventListener("click", startRecognition);

      const sendImg = document.createElement("img");
      sendImg.id = "sendBtn";
      sendImg.src = "img/enviar.png";
      sendImg.alt = "Enviar";
      sendImg.className = "send-img";
      sendImg.title = "Enviar";
      sendImg.addEventListener("click", sendMessage);

      right.appendChild(micImg);
      right.appendChild(sendImg);

      bubble.appendChild(left);
      bubble.appendChild(right);
      stack.appendChild(bubble);
    }

    function addUserQuestion(text){
      if (!text || !text.trim()) return;
      const stack = document.getElementById("bubbleStack");
      const bubble = document.createElement("div");
      bubble.className = "bubble user";
      const msg = document.createElement("div");
      msg.textContent = text.trim();
      bubble.appendChild(msg);
      stack.appendChild(bubble);
    }

    function addBotAnswer(text){
      const stack = document.getElementById("bubbleStack");
      const bubble = document.createElement("div");
      bubble.className = "bubble bot";
      const msg = document.createElement("div");
      msg.textContent = text;
      bubble.appendChild(msg);
      stack.appendChild(bubble);
      stack.parentElement.scrollTo({ top: stack.parentElement.scrollHeight, behavior: "smooth" });
    }

    function setUIBusy(busy){
      document.getElementById("textInput").disabled = busy;
    }

    // Envío con Enter
    document.addEventListener("keydown", (e)=>{
      const input = document.getElementById("textInput");
      if (document.activeElement === input && e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    // ==== Enviar mensaje (con threadId) ====
    async function sendMessage() {
      const input = document.getElementById("textInput");
      const inputValue = input.value.trim();
      if (!inputValue) return;

      // Si estaba dictando, parar
      if (recognition && micActivo) {
        recognition.stop();
      }

      addUserQuestion(inputValue);

      input.value = "";
      document.getElementById("loadingDots").style.display = "flex";
      setUIBusy(true);

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: inputValue,
            threadId: THREAD_ID // NUEVO
          })
        });

        const data = await response.json();

        // ====== NUEVO: guardar threadId devuelto por el backend ======
        if (data.threadId && data.threadId !== THREAD_ID) {
          THREAD_ID = data.threadId;
          localStorage.setItem("openai_thread_id", THREAD_ID);
        }

        const respuestaTexto = data?.response
          ? (typeof data.response === "object"
              ? (data.response.message || data.response.content || JSON.stringify(data.response))
              : String(data.response))
          : "No se recibió una respuesta válida.";

        addBotAnswer(respuestaTexto);
        speak(respuestaTexto);

      } catch (e) {
        console.error(e);
        addBotAnswer("No se pudo conectar con la IA.");
      } finally {
        document.getElementById("loadingDots").style.display = "none";
        setUIBusy(false);
      }
    }

    // ====== (Opcional) Reiniciar la conversación desde el front ======
    // Llama a resetThread() desde un botón si te interesa empezar de cero.
    function resetThread(){ // NUEVO (opcional)
      localStorage.removeItem("openai_thread_id");
      THREAD_ID = null;
      addBotAnswer("🗑️ Conversación reiniciada.");
    }
  </script>
</body>
</html>


